name: Run Python Script Daily

on:
  schedule:
    # Runs at 9:30 AM UTC (slightly before 9:32 AM IST to account for queueing delay)
    - cron: '30 3 * * *'
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # --- ADDED STEPS FOR PRECISION START ---
    - name: Set Timezone to IST
      run: sudo timedatectl set-timezone Asia/Kolkata
    
    - name: Wait for exact 9:32 AM IST
      run: |
        TARGET_TIME="09:32:00"
        NOW=$(date +%s)
        TARGET_TIMESTAMP=$(date -d "$TARGET_TIME" +%s)
        
        if [ "$NOW" -gt "$TARGET_TIMESTAMP" ]; then
          echo "Workflow started late, running immediately."
        else
          DELAY=$((TARGET_TIMESTAMP - NOW))
          echo "Waiting for $DELAY seconds to reach $TARGET_TIME IST..."
          sleep $DELAY
        fi
      shell: bash
    # --- ADDED STEPS FOR PRECISION END ---

    - name: Run script
      run: python script.py

    - name: Upload CSV file
      uses: actions/upload-artifact@v4
      with:
        name: daily-gainers-csv
        path: ./*.csv
        retention-days: 30
